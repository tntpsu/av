# AV Stack Configuration File
# All tunable parameters for the AV stack

# Control Parameters
control:
  # Lateral (Steering) Control
  lateral:
    kp: 2.2              # INCREASED: From 2.0 to 2.2 for better error response
                          # Test showed kp=2.0, ki=0.004, heading_weight=0.75 still produces RMSE 0.500m
                          # Slight increase to 2.2 to meet 0.4m threshold
                          # Previous: kp=2.5 caused oscillation, kp=2.2 should be safe
                          # Will monitor for oscillation in Unity testing
    ki: 0.004            # INCREASED: From 0.003 to 0.004 for better steady-state correction
                          # Test showed kp=2.0, ki=0.003 still produces RMSE 0.500m (above 0.4m threshold)
                          # Increasing ki helps eliminate persistent lateral offset
                          # Still within safe range (0.003-0.005) to prevent integral accumulation
    kd: 0.5              # FIXED: Increased from 0.45 to 0.5 to match higher kp
                          # Provides good damping without over-damping
    max_steering: 1.0    # INCREASED: Maximum steering angle (-1.0 to 1.0)
                          # Analysis showed:
                          #   - 16.5% of frames hit 0.5 limit on curves
                          #   - Theoretical requirement for curve: ~1.19
                          #   - Extreme error corrections need ~1.1 steering
                          # Increased to 1.0 (full steering authority) to handle curves and corrections
                          # This is 100% more steering authority than original 0.5
    deadband: 0.01       # Deadband in radians (~0.57 degrees) - errors smaller than this are ignored
    heading_weight: 0.75  # INCREASED: From 0.7 to 0.75 for stronger heading correction
                          # Test showed heading_weight=0.7 still produces RMSE 0.500m (above 0.4m threshold)
                          # Critical: Heading correction is key to reducing lateral error over time
                          # Higher weight prioritizes heading correction over lateral offset
                          # Helps reduce lateral error RMSE (target: < 0.4m)
    lateral_weight: 0.25  # DECREASED: From 0.3 to 0.25 to balance with increased heading weight (0.75)
    error_clip: 1.57    # INCREASED: Maximum error in radians (π/2 = 90 degrees, was π/4 = 45°)
                        # Analysis showed error_clip=0.785 was limiting PID input, causing low effective gain
                        # Increasing to π/2 allows PID to use more of the kp value (2.5)
                        # This should improve effective gain from 13.7% to >40%
    integral_limit: 0.10  # Maximum integral term (prevents windup) - REDUCED from 0.15 to prevent accumulation
                          # Current issue: 11.63x increase after 6s - need stricter limit
  
  # Longitudinal (Speed) Control
  longitudinal:
    kp: 0.10            # Proportional gain (FURTHER REDUCED: was 0.15, still too aggressive - car accelerates too fast)
    ki: 0.01            # Integral gain (REDUCED: was 0.02, to prevent overshoot)
    kd: 0.01            # Derivative gain (kept same for damping)
    target_speed: 8.0    # Target speed in m/s
    max_speed: 10.0      # Maximum allowed speed in m/s
    speed_smoothing: 0.7 # Exponential smoothing factor (0.0 to 1.0, higher = more smoothing)
    speed_deadband: 0.1  # Speed error deadband in m/s
    throttle_limit_threshold: 0.75  # Start reducing throttle at this fraction of max_speed
    throttle_reduction_factor: 0.3 # Throttle multiplier when near max speed
    brake_aggression: 2.0 # Brake PID gain multiplier

# Trajectory Planning Parameters
trajectory:
  lookahead_distance: 20.0  # How far ahead to plan in meters
  point_spacing: 1.0        # Spacing between trajectory points in meters
  target_speed: 8.0         # Target speed for trajectory in m/s
  reference_lookahead: 8.0  # Lookahead distance for reference point in meters
  
  # Camera/Image Parameters
  image_width: 640          # Camera image width in pixels
  image_height: 480         # Camera image height in pixels
  camera_fov: 110.0         # Camera field of view in degrees (HORIZONTAL FOV - matches Unity Inspector)
                             # Unity Inspector shows "Field of View Axis: Horizontal" with value 110°
                             # This value is used directly as horizontal FOV for lateral coordinate conversion
  camera_height: 1.2        # Camera height above ground in meters (matches Unity camera local Y)
                             # From Unity scene: Camera local Y=0.5m + Car center Y=0.5m = 1.0m
                             # Camera is positioned on hood edge (local z=0.5m forward from car center)
  camera_offset_x: 0.0   # NEW: Lateral offset of camera from vehicle center (meters, positive = right)
                         # RESET: Reverted to 0.0 - previous 0.47m caused massive overcorrection (112m bias)
                         # Need to recalibrate more carefully with smaller increments
                         # This compensates for camera misalignment and coordinate conversion bias
  distance_scaling_factor: 0.875  # NEW: Distance scaling to account for camera pitch
                                   # When camera looks down, point 8m straight ahead in camera space
                                   # is actually closer in world space when projected to ground.
                                   # Default: 7/8 = 0.875 (based on visualizer tuning where 7m aligns correctly)
                                   # This corrects lane width from 8.5m to 7.0m
  
  # Center Lane Bias Correction
  bias_correction_threshold: 10.0  # Pixels - if center lane offset > this, apply correction
  
  # Reference Point Smoothing
  reference_smoothing: 0.80  # Exponential smoothing alpha (0.0-1.0, higher = more smoothing)
                              # REVERTED: Back to 0.80 (was working better)
                              # 0.77 caused 5.79x integral accumulation and diverging errors
                              # 0.80 provides better stability (1.31x integral, converging errors)
                              # Keep rate limit increase (0.15) for responsiveness
  
  # Lane Coefficient Temporal Filtering
  lane_smoothing_alpha: 0.8  # Exponential smoothing for lane coefficients (0.0-1.0, higher = more smoothing)
                              # REVERTED: Back to 0.8 (was working better)
                              # Matches previous good state that had 1.31x integral accumulation
                              # This prevents small pixel errors from amplifying into large meter errors

# Speed Safety Limits
safety:
  max_speed: 10.0           # Hard speed limit in m/s
  emergency_brake_threshold: 1.5  # Emergency brake if speed > max_speed * this (LOWERED: was 2.0, too high - allows 15 m/s!)
  speed_prevention_threshold: 0.70 # Start preventing acceleration at this fraction of max_speed (LOWERED: was 0.80, too late)
  speed_prevention_brake_threshold: 0.85  # Apply light brake at this fraction of max_speed (LOWERED: was 0.90, too late)
  speed_prevention_brake_amount: 0.4  # Light brake amount when preventing speed (INCREASED: was 0.3, too weak)
  
  # NEW: Lateral error safety bounds (critical for long-term stability)
  # Critical: 89.4% steering direction errors and 8.95m max error indicate need for safety bounds
  max_lateral_error: 2.0  # Hard limit: If error exceeds 2.0m, apply aggressive correction
  recovery_lateral_error: 1.0  # Recovery trigger: If error exceeds 1.0m, initiate recovery mode
  emergency_stop_error: 3.0  # Emergency stop: If error exceeds 3.0m, stop immediately
  
  # Out-of-bounds detection (calculated from lane/car dimensions)
  # Formula: threshold = (lane_width/2 - car_width/2 + allowed_outside_lane)
  # This accounts for car width and allows some distance outside lane before emergency stop
  # For 7m lane, 1.85m car, 1.0m allowed: threshold = 3.5 - 0.925 + 1.0 = 3.575m
  lane_width: 7.0  # Lane width in meters (distance between lane lines)
  car_width: 1.85  # Car width in meters (from Unity prefab scale.x)
  allowed_outside_lane: 1.0  # Allowed distance outside lane before emergency stop (meters)
                              # Car can be this far outside lane edge before triggering emergency stop

# Logging
logging:
  frame_log_interval: 30    # Log every N frames (30 = ~1 second at 30 FPS)
  log_lateral_error: true   # Include lateral error in logs
  log_reference_point: true # Include reference point in logs

