control:
  lateral:
    kp: 1.1
    ki: 0.004
    kd: 0.18
    max_steering: 0.6
    deadband: 0.05
    heading_weight: 0.5
    lateral_weight: 0.5
    error_clip: 1.57
    integral_limit: 0.1
    steering_smoothing_alpha: 0.9
    control_mode: pure_pursuit  # pid | stanley | pure_pursuit
    stanley_k: 1.5
    stanley_soft_speed: 2.0
    stanley_heading_weight: 1.0
    # Pure Pursuit params (active when control_mode=pure_pursuit)
    pp_feedback_gain: 0.15  # PID feedback blend (0=pure geometric, 1=full PID)
    pp_min_lookahead: 0.5  # min effective lookahead distance (m), prevents singularity
    pp_ref_jump_clamp: 0.5  # max ref_x change per frame (m), second safety net
    pp_stale_decay: 0.98  # per-frame steering decay when perception is stale
    feedback_gain_min: 1.1
    feedback_gain_max: 1.4
    feedback_gain_curvature_min: 0.003
    feedback_gain_curvature_max: 0.03
    base_error_smoothing_alpha: 0.7
    heading_error_smoothing_alpha: 0.45
    straight_window_frames: 60
    straight_oscillation_high: 0.2
    straight_oscillation_low: 0.05
    curve_feedforward_gain: 1.0
    curve_feedforward_threshold: 0.012
    curve_feedforward_gain_min: 1.0
    curve_feedforward_gain_max: 1.15
    curve_feedforward_curvature_min: 0.001
    curve_feedforward_curvature_max: 0.015
    curve_feedforward_curvature_clamp: 0.025
    curvature_scale_factor: 12.0
    curvature_scale_threshold: 0.0005
    curvature_stale_hold_seconds: 0.3
    curvature_stale_hold_min_abs: 0.0005
    curvature_smoothing_alpha: 0.5        # C1: reduced from 0.7 (trajectory now provides smoother curvature)
    curvature_transition_threshold: 0.01
    curvature_transition_alpha: 0.3
    curve_feedforward_bins:
    - min_curvature: 0.0
      max_curvature: 0.02
      gain_scale: 1.0
    - min_curvature: 0.02
      max_curvature: 10.0
      gain_scale: 1.3
    straight_curvature_threshold: 0.01
    curve_upcoming_enter_threshold: 0.012
    curve_upcoming_exit_threshold: 0.009
    curve_upcoming_on_frames: 2
    curve_upcoming_off_frames: 2
    curve_phase_use_distance_track: true
    curve_phase_track_name: s_loop
    curve_at_car_distance_min_m: 0.0
    road_curve_enter_threshold: 0.011
    road_curve_exit_threshold: 0.009
    road_straight_hold_invalid_frames: 6
    steering_rate_curvature_min: 0.003
    steering_rate_curvature_max: 0.015
    steering_rate_scale_min: 0.55
    curve_rate_floor_moderate_error: 0.2
    curve_rate_floor_large_error: 0.24
    straight_sign_flip_error_threshold: 0.03
    straight_sign_flip_rate: 0.5
    straight_sign_flip_frames: 6
    steering_jerk_limit: 0.12
    steering_jerk_curve_scale_max: 1.0
    steering_jerk_curve_min: 0.003
    steering_jerk_curve_max: 0.015
    curve_entry_assist_enabled: false
    curve_entry_assist_error_min: 0.3
    curve_entry_assist_heading_error_min: 0.1
    curve_entry_assist_curvature_min: 0.01
    curve_entry_assist_rate_boost: 1.12
    curve_entry_assist_jerk_boost: 1.08
    curve_entry_assist_max_frames: 18
    curve_entry_assist_watchdog_rate_delta_max: 0.22
    curve_entry_assist_rearm_frames: 20
    curve_entry_schedule_enabled: false
    curve_entry_schedule_frames: 24
    curve_entry_schedule_min_rate: 0.22
    curve_entry_schedule_min_jerk: 0.16
    curve_entry_schedule_min_hold_frames: 12
    curve_entry_schedule_min_curve_progress_ratio: 0.2
    curve_entry_schedule_fallback_only_when_dynamic: true
    curve_entry_schedule_fallback_deficit_frames: 6
    curve_entry_schedule_fallback_rate_deficit_min: 0.03
    curve_entry_schedule_fallback_rearm_cooldown_frames: 18
    curve_entry_schedule_handoff_transfer_ratio: 0.68
    curve_entry_schedule_handoff_error_fall: 0.03
    dynamic_curve_authority_enabled: true
    dynamic_curve_rate_deficit_deadband: 0.01
    dynamic_curve_rate_boost_gain: 1.0
    dynamic_curve_rate_boost_max: 0.34
    dynamic_curve_jerk_boost_gain: 4.0
    dynamic_curve_jerk_boost_max_factor: 3.8
    dynamic_curve_hard_clip_boost_gain: 1.0
    dynamic_curve_hard_clip_boost_max: 0.2
    dynamic_curve_entry_governor_enabled: true
    dynamic_curve_entry_governor_gain: 1.2
    dynamic_curve_entry_governor_max_scale: 1.8
    dynamic_curve_entry_governor_stale_floor_scale: 1.15
    dynamic_curve_entry_governor_exclusive_mode: true
    dynamic_curve_entry_governor_anticipatory_enabled: true
    dynamic_curve_entry_governor_upcoming_phase_weight: 0.75
    dynamic_curve_authority_precurve_enabled: true
    dynamic_curve_authority_precurve_scale: 1.0
    dynamic_curve_single_owner_mode: true
    dynamic_curve_single_owner_min_rate: 0.22
    dynamic_curve_single_owner_min_jerk: 0.6
    dynamic_curve_comfort_lat_accel_comfort_max_g: 0.18
    dynamic_curve_comfort_lat_accel_peak_max_g: 0.25
    dynamic_curve_comfort_lat_jerk_comfort_max_gps: 0.30
    dynamic_curve_lat_jerk_smoothing_alpha: 0.25
    dynamic_curve_lat_jerk_soft_start_ratio: 0.60
    dynamic_curve_lat_jerk_soft_floor_scale: 0.35
    dynamic_curve_speed_low_mps: 4.0
    dynamic_curve_speed_high_mps: 10.0
    dynamic_curve_speed_boost_max_scale: 1.4
    turn_feasibility_governor_enabled: true
    turn_feasibility_curvature_min: 0.002
    turn_feasibility_guardband_g: 0.015
    turn_feasibility_use_peak_bound: true
    curve_unwind_policy_enabled: true
    curve_unwind_frames: 12
    curve_unwind_rate_scale_start: 1.0
    curve_unwind_rate_scale_end: 0.8
    curve_unwind_jerk_scale_start: 1.0
    curve_unwind_jerk_scale_end: 0.7
    curve_unwind_integral_decay: 0.85
    curve_commit_mode_enabled: false
    curve_commit_mode_max_frames: 24
    curve_commit_mode_min_rate: 0.22
    curve_commit_mode_min_jerk: 4.0
    curve_commit_mode_transfer_ratio_target: 0.72
    curve_commit_mode_error_fall: 0.03
    curve_commit_mode_exit_consecutive_frames: 4
    curve_commit_mode_retrigger_on_dynamic_deficit: true
    curve_commit_mode_dynamic_deficit_frames: 8
    curve_commit_mode_dynamic_deficit_min: 0.03
    curve_commit_mode_retrigger_cooldown_frames: 12
    curve_mode_speed_cap_enabled: true       # B1: Enable curvature-based speed cap
    curve_mode_speed_cap_mps: 8.0            # B1: Start conservative (was 7.2)
    curve_mode_speed_cap_min_ratio: 0.55
    speed_gain_min_speed: 4.0
    speed_gain_max_speed: 10.0
    speed_gain_min: 1.0
    speed_gain_max: 1.5
    speed_gain_curvature_min: 0.002
    speed_gain_curvature_max: 0.008
  longitudinal:
    kp: 0.25
    ki: 0.02
    kd: 0.01
    max_accel: 1.2
    max_decel: 2.4
    max_jerk: 0.7
    max_jerk_min: 1.5
    max_jerk_max: 6.0
    jerk_error_min: 0.5
    jerk_error_max: 3.0
    accel_feedforward_gain: 1.0
    decel_feedforward_gain: 1.0
    speed_for_jerk_alpha: 0.8
    jerk_cooldown_frames: 5
    jerk_cooldown_scale: 0.5
    speed_error_to_accel_gain: 0.1
    speed_error_deadband: 0.2
    speed_error_gain_under: 0.12
    speed_error_gain_over: 0.08
    overspeed_accel_zero_threshold: 0.2
    overspeed_brake_threshold: 0.4
    overspeed_brake_min: 0.03
    overspeed_brake_max: 0.18
    overspeed_brake_gain: 0.25
    accel_mode_threshold: 0.15
    decel_mode_threshold: 0.1
    speed_error_accel_threshold: 0.2
    speed_error_brake_threshold: -0.6
    mode_switch_min_time: 0.4
    coast_hold_seconds: 0.7
    coast_throttle_kp: 0.1
    coast_throttle_max: 0.12
    straight_throttle_cap: 0.3
    straight_curvature_threshold: 0.003
    accel_tracking_enabled: true
    accel_tracking_error_scale: 0.35
    accel_pid_kp: 0.5
    accel_pid_ki: 0.02
    accel_pid_kd: 0.02
    throttle_curve_gamma: 1.4
    throttle_curve_min: 0.0
    speed_drag_gain: 0.035
    accel_target_smoothing_alpha: 0.86
    continuous_accel_control: true
    continuous_accel_deadband: 0.05
    startup_ramp_seconds: 4.0
    startup_accel_limit: 0.7
    startup_speed_threshold: 2.0
    startup_throttle_cap: 0.15
    startup_disable_accel_feedforward: true
    low_speed_accel_limit: 0.8
    low_speed_speed_threshold: 2.0
    target_speed: 12.0
    max_speed: 12.0
    speed_smoothing: 0.3
    speed_deadband: 0.03
    throttle_limit_threshold: 0.9
    throttle_reduction_factor: 0.15
    brake_aggression: 2.0
    throttle_rate_limit: 0.04
    brake_rate_limit: 0.07
    throttle_smoothing_alpha: 0.75
    min_throttle_when_accel: 0.1
    min_throttle_hold: 0.16
    min_throttle_hold_speed: 4.0
    target_speed_slew_rate_up: 1.5
    target_speed_slew_rate_down: 2.5
    target_speed_slew_error_min: 0.5
    target_speed_slew_error_max: 3.0
    target_speed_slew_rate_up_min: 0.6
    target_speed_slew_rate_up_max: 2.0
    target_speed_slew_rate_down_min: 1.0
    target_speed_slew_rate_down_max: 3.0
    target_speed_stop_threshold: 0.5
    target_speed_restart_ramp_seconds: 2.5
    launch_throttle_stop_threshold: 2.0
    launch_throttle_ramp_seconds: 2.5
    launch_throttle_cap_min: 0.15
    launch_throttle_cap_max: 0.55
    launch_throttle_rearm_hysteresis: 0.5
    launch_throttle_stop_hold_seconds: 0.5
trajectory:
  trajectory_source: planner
  lookahead_distance: 20.0
  point_spacing: 1.0
  target_speed: 12.0
  reference_lookahead: 9.0
  dynamic_reference_lookahead: true
  reference_lookahead_min: 3.0
  reference_lookahead_scale_min: 0.55
  reference_lookahead_speed_min: 4.0
  reference_lookahead_speed_max: 10.0
  reference_lookahead_curvature_min: 0.002
  reference_lookahead_curvature_max: 0.015
  reference_lookahead_tight_curvature_threshold: 0.02
  reference_lookahead_tight_scale: 0.7
  use_vehicle_frame_lookahead_ref: false
  vehicle_frame_lookahead_scale: 1.0
  vehicle_frame_lookahead_scale_left: 1.0
  vehicle_frame_lookahead_scale_right: 1.05
  curvature_smoothing_enabled: true
  curvature_smoothing_window_m: 12.0
  curvature_smoothing_min_speed: 2.0
  straight_speed_smoothing_alpha: 0.2
  straight_speed_smoothing_curvature_threshold: 0.003
  straight_speed_slew_rate_up: 0.4
  straight_target_hold_seconds: 1.0
  straight_target_hold_limit_delta: 0.3
  target_speed_blend_window_m: 20.0
  target_speed_blend_reset_seconds: 0.5
  max_lateral_accel: 1.3
  min_curve_speed: 3.2
  curvature_bins:
  - min_curvature: 0.0
    max_curvature: 0.01
    max_lateral_accel: 1.3
    min_curve_speed: 3.2
  - min_curvature: 0.01
    max_curvature: 0.02
    max_lateral_accel: 1.25
    min_curve_speed: 3.1
  - min_curvature: 0.02
    max_curvature: 10.0
    max_lateral_accel: 0.9
    min_curve_speed: 3.0
  speed_limit_slew_rate: 1.0
  speed_limit_slew_rate_up: 2.5
  speed_limit_slew_rate_down: 1.5
  speed_limit_preview_distance: 12.0
  speed_limit_preview_decel: 2.5
  speed_limit_preview_stability_frames: 10
  speed_limit_preview_change_delta: 0.3
  speed_limit_preview_hold_curvature_threshold: 0.01
  speed_limit_preview_hold_release_delta: 0.5
  speed_limit_preview_hold_release_frames: 3
  speed_limit_preview_hold_min_distance_margin: 0.5
  curve_speed_preview_enabled: true
  curve_speed_preview_lookahead_scale: 1.6
  curve_speed_preview_distance: 10.0
  curve_speed_preview_decel: 1.8
  curve_speed_preview_min_curvature: 0.002
  steering_speed_guard_enabled: true
  steering_speed_guard_threshold: 0.55
  steering_speed_guard_scale: 0.7
  steering_speed_guard_min_speed: 3.0
  curvature_limit_min_abs: 0.001
  min_speed_limit_ratio: 0.6
  min_speed_floor: 3.0
  min_speed_curvature_max: 0.02
  speed_planner:
    enabled: true
    max_accel: 2.0
    max_decel: 2.5
    max_jerk: 1.2
    max_jerk_min: 0.6
    max_jerk_max: 1.2
    jerk_error_min: 0.3
    jerk_error_max: 2.0
    use_speed_dependent_limits: true
    accel_speed_min: 0.0
    accel_speed_max: 12.0
    max_accel_at_speed_min: 1.2
    max_accel_at_speed_max: 1.2
    decel_speed_min: 0.0
    decel_speed_max: 12.0
    max_decel_at_speed_min: 2.5
    max_decel_at_speed_max: 2.5
    enforce_desired_speed_slew: true
    min_speed: 0.0
    launch_speed_floor: 2.0
    launch_speed_floor_threshold: 1.0
    reset_gap_seconds: 0.5
    sync_speed_threshold: 50.0
    speed_error_gain: 0.0
    speed_error_max_delta: 0.4
    speed_error_deadband: 0.2
    speed_limit_bias: -0.2
    sync_under_target: false
    sync_under_target_error: 0.2
  image_width: 640
  image_height: 480
  camera_fov: 66.0
  camera_height: 1.4
  camera_offset_x: 0.0
  distance_scaling_factor: 0.875
  bias_correction_threshold: 10.0
  reference_smoothing: 0.75
  lane_smoothing_alpha: 0.8
  center_spline_enabled: true
  center_spline_degree: 2
  center_spline_samples: 30
  center_spline_alpha: 0.8
  x_clip_enabled: true
  x_clip_limit_m: 15.0
  trajectory_eval_y_min_ratio: 0.1
  centerline_midpoint_mode: coeff_average
  projection_model: legacy
  calibrated_fx_px: 0.0
  calibrated_fy_px: 0.0
  calibrated_cx_px: 0.0
  calibrated_cy_px: 0.0
  target_lane: right
  target_lane_width_m: 3.6
  ref_sign_flip_threshold: 0.12
  ref_x_rate_limit: 0.12
  ref_x_rate_limit_turn_heading_min_abs_rad: 0.06
  ref_x_rate_limit_turn_scale_max: 2.5
  ref_sign_flip_disable_on_turn: true
  ref_sign_flip_disable_heading_min_abs_rad: 0.02
  ref_x_rate_limit_precurve_enabled: true
  ref_x_rate_limit_precurve_heading_min_abs_rad: 0.03
  ref_x_rate_limit_precurve_scale_max: 5.0
  multi_lookahead_enabled: true
  multi_lookahead_far_scale: 1.4
  multi_lookahead_blend_alpha: 0.25
  multi_lookahead_curvature_threshold: 0.01
  multi_lookahead_curve_heading_smoothing_alpha: 0.75
  multi_lookahead_curve_heading_min_abs_rad: 0.05
  # A1: Planner heading-zero gate thresholds (image-space)
  heading_zero_quad_threshold: 0.005      # tighter than old 0.01; image-space quadratic coeff
  heading_zero_curvature_guard: 0.001     # lowered from 0.002: recordings show heading zeroed at curvature 0.0005-0.0015
  # A3: Curvature-aware smoothing / rate-limit relaxation
  smoothing_alpha_curve_reduction: 0.15   # alpha reduction when curvature increasing (3+ frames)
  ref_x_rate_limit_curvature_min: 0.003   # curvature threshold for rate limit relaxation
  ref_x_rate_limit_curvature_scale_max: 3.0  # max rate limit multiplier from curvature
  traj_heading_zero_gate_center_a_on_abs_max: 0.004
  traj_heading_zero_gate_center_a_off_abs_max: 0.008
  traj_heading_zero_gate_heading_on_abs_rad: 0.035
  traj_heading_zero_gate_heading_off_abs_rad: 0.061
  dynamic_effective_horizon_enabled: true
  dynamic_effective_horizon_min_m: 3.0
  dynamic_effective_horizon_max_m: 20.0
  dynamic_effective_horizon_speed_scale: 0.35
  dynamic_effective_horizon_curvature_scale: 0.15
  dynamic_effective_horizon_farfield_scale_min: 0.85
  dynamic_effective_horizon_confidence_floor: 0.6
  dynamic_effective_horizon_confidence_fallback: 1.0
  far_band_contribution_cap_enabled: true
  far_band_contribution_cap_start_m: 12.0
  far_band_contribution_cap_gain: 0.45
  speed_horizon_guardrail_enabled: true
  speed_horizon_guardrail_time_headway_s: 1.8
  speed_horizon_guardrail_margin_m: 1.0
  speed_horizon_guardrail_min_speed_mps: 3.0
  speed_horizon_guardrail_gain: 1.0
  lane_position_smoothing_alpha: 0.35
  ref_point_jump_clamp_x: 0.15
  ref_point_jump_clamp_heading: 0.08
  reference_x_max_abs: 3.2
safety:
  max_speed: 12.0
  emergency_brake_threshold: 1.5
  speed_prevention_threshold: 0.9
  speed_prevention_brake_threshold: 0.95
  speed_prevention_brake_amount: 0.2
  max_lateral_error: 2.0
  recovery_lateral_error: 1.0
  emergency_stop_error: 4.0
  emergency_stop_release_speed: 0.2
  emergency_stop_end_run_after_seconds: 3.0
  emergency_stop_use_gt_lane_boundaries: true
  emergency_stop_gt_lane_boundary_margin: 0.05
  lane_width: 7.0
  car_width: 1.9
  allowed_outside_lane: 1.0
logging:
  frame_log_interval: 30
  log_lateral_error: true
  log_reference_point: true
perception:
  record_segmentation_mask: false
  low_visibility_fallback_enabled: true
  low_visibility_fallback_blend_alpha: 0.35
  low_visibility_fallback_max_consecutive_frames: 8
  low_visibility_fallback_center_shift_cap_m: 0.25
  segmentation_fit_min_row_ratio: 0.45
  segmentation_fit_max_row_ratio: 0.75
  segmentation_ransac_enabled: true
  segmentation_ransac_residual_px: 10.0
  segmentation_ransac_min_inliers: 8
  segmentation_ransac_max_trials: 100
  model_fallback_confidence_hard_threshold: 0.1
  model_fallback_zero_lane_confidence_threshold: 0.6
  lane_width_min_m: 1.0
  lane_width_max_m: 10.0
  lane_center_change_clamp_m: 0.4
  lane_width_change_clamp_m: 0.5
  lane_line_change_clamp_m: 0.25
  lane_side_sign_enforce: true
  lane_side_sign_min_abs_m: 0.25
  lane_center_ema_alpha: 0.15
  lane_width_ema_alpha: 0.2
  lane_center_gate_m: 0.3
  lane_width_gate_m: 0.6
  lane_center_ab_beta: 0.12
  lane_width_ab_beta: 0.08
lateral_control:
  heading_weight: 0.5
  lateral_weight: 0.5
  steering_smoothing_alpha: 0.7
  steering_rate_scale_min: 0.8
  steering_jerk_limit: 0.0
